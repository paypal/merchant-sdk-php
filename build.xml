<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project>
<project name="PayPal_Merchant_SDK" default="build">

	<property name="tests.dir" value="tests"/>
	<property name="tests.out.dir" value="tests\reports"/>
	
	<condition property="PHPUNIT_BIN" value="phpunit.bat" else="phpunit">
		<os family="windows" />
	</condition>

	<target name="clean">
		<delete dir="${tests.out.dir}" />
	</target>

	<target name="test">
		<mkdir dir="${tests.out.dir}" />
		<exec dir="${basedir}" executable="${PHPUNIT_BIN}" failonerror="true">
			<arg line="--testdox --include-path lib --log-junit ${tests.out.dir}\phpunit.xml ${tests.dir}" />
		</exec>
	</target>

	<target name="build" depends="clean, create-autoloader, test" />

    <target name="create-autoloader">
        <delete file="${basedir}/lib/${ant.project.name}_Autoloader.php" />

        <exec dir="${basedir}" executable="git" failonerror="true" outputproperty="classList">
            <!-- Use git's grep -->
            <arg line="grep -e '^class ' lib/" />
            <redirector>
                <outputfilterchain>
                    <replaceregex
                        pattern="lib/([^:]*):class ([^ ]*).*"
                        replace="            '\2' => '/\1'," />
                    <sortfilter />
                </outputfilterchain>
            </redirector>
        </exec>

        <concat destfile="${basedir}/lib/${ant.project.name}_Autoloader.php"><![CDATA[<?php
/**
 * Basic class-map auto loader, generated by ant target "create-autoloader"
 * Do not modify
 */
class ${ant.project.name}_AutoLoader
{
    private static $map = array(
${classList}
    );

    public static function loadClass($class)
    {
        $class = trim($class, '\\');

        if (isset(self::$map[$class])) {
            require dirname(__FILE__) . self::$map[$class];
        }
    }

    public static function register()
    {
        spl_autoload_register(array(__CLASS__, 'loadClass'), true);
    }
}
]]></concat>


    </target>

</project>
